<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Araç Takip Sistemi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #sidebar {
      width: 250px;
      height: 100vh;
      background-color: #343a40;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      padding-top: 60px;
      transition: all 0.3s;
    }

    #sidebar.hidden {
      transform: translateX(-100%);
    }

    #sidebar ul {
      list-style: none;
      padding-left: 20px;
    }

    #sidebar ul li {
      margin: 15px 0;
    }

    #sidebar ul li a {
      color: white;
      text-decoration: none;
    }

    #topNavbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1030;
    }

    #main-content {
      margin-left: 250px;
      padding: 70px 20px 20px 20px;
      transition: margin-left 0.3s;
    }

    #main-content.full {
      margin-left: 0;
    }

    .toggle-btn {
      cursor: pointer;
    }

    #user-area {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-weight: 500;
    }

    #logout-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1.3rem;
      padding: 0;
    }

    #logout-btn:hover {
      color: #ff7300;
    }

    /* Başlık ve arama + buton düzeni */
    #header-bar {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    #header-bar h3 {
      margin: 0;
      white-space: nowrap;
    }

    #plateSearch {
      width: 250px;
      min-width: 200px;
    }
    
  </style>
</head>

<body>
  <nav id="topNavbar" class="navbar navbar-dark bg-dark fixed-top">
    <div class="container-fluid d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <span class="navbar-toggler-icon toggle-btn me-3" onclick="toggleSidebar()"></span>
        <a class="navbar-brand d-flex align-items-center" href="home.html">
          <img src="logo.png" alt="Logo" width="40" height="34" style="margin-top: 3px; margin-left: 50px;" />
          <span style="font-family: Georgia, 'Times New Roman', Times, serif;">Araç Takip Sistemi</span>
        </a>
      </div>
      <div id="user-area">
        <a href="login.html" class="btn btn-outline-light me-2" id="login-btn">Giriş Yap</a>
        <span id="user-name" style="display:none;"></span>
        <button id="logout-btn" style="display:none;" title="Çıkış Yap">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </div>
    
    </div>
    
  </nav>
 
 <div id="sidebar">
    <ul>
      <li><a href="home.html">Ana Sayfa</a> <hr></li>
      <li><a href="allvehicles.html">Tüm Araçlar</a><hr></li>
      <li><a href="aracsorgula.html">Araç Sorgula</a><hr></li>
    </ul>
  </div>

  <div id="main-content">

    <div id="header-bar">
      <h3>Tüm Araçlar</h3>

      <!-- Plaka arama formu -->
      <form id="searchForm" style="margin: 0;">
        <input
          type="text"
          class="form-control"
          id="plateSearch"
          placeholder="Plaka ile ara... (örn: 34ABC34)"
          autocomplete="off"
          aria-label="Plaka ile ara"
        />
      </form>

      <!-- Yeni Araç Butonu -->
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newVehicleModal">+ Yeni Araç</button>
    </div>
    

    <div class="table-responsive">
      <table class="table table-striped" id="vehicles-table">
        <thead>
           <tr>
  <th id="plaka-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Plaka
      <span id="plaka-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
  <th id="durum-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Durum
      <span id="durum-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
  <th id="marka-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Marka
      <span id="marka-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
  <th id="model-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Model
      <span id="model-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
  <th id="modelyilii-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Model Yılı
      <span id="modelyilii-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
  <th id="kilometre-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Kilometre
      <span id="kilometre-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
  <th id="vites-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Vites
      <span id="vites-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
  <th id="yakit-header" style="cursor: pointer;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      Yakıt Türü
      <span id="yakit-sort-icon" style="margin-left: 8px;">
        <svg width="14" height="14" viewBox="0 0 14 14">
          <rect width="14" height="2" y="0" fill="black" />
          <rect width="14" height="2" y="6" fill="gray" />
          <rect width="14" height="2" y="12" fill="gray" />
        </svg>
      </span>
    </div>
  </th>
</tr>
        </thead>
        <tbody>
          <!-- Araçlar buraya yüklenecek -->
        </tbody>
      </table>
    </div>
  </div>

 

  <!-- Yeni Araç Ekleme Modalı -->
  <div
    class="modal fade"
    id="newVehicleModal"
    tabindex="-1"
    aria-labelledby="newVehicleModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="newVehicleForm">
          <div class="modal-header">
            <h5 class="modal-title" id="newVehicleModalLabel">Yeni Araç Ekle</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
          <div class="modal-body">
  <div class="row g-3">
    <div class="col-md-6">
      <label for="plaka" class="form-label">Plaka *</label>
      <input type="text" class="form-control" id="plaka" required />
    </div>
    <div class="col-md-6">
  <label for="durum" class="form-label">Durum</label>
  <select class="form-select" id="durum">
    <option value="">Seçiniz...</option>
    <option value="Kiralanabilir">Kiralanabilir</option>
    <option value="Kirada">Kirada</option>
    <option value="Serviste">Serviste</option>
    <option value="Bakımda">Bakımda</option>
    <option value="Yıkamada">Yıkamada</option>
    <option value="Yakıt İkmalinde">Yakıt İkmalinde</option>
    </select>
</div>

    <div class="col-md-6" >
      <label for="marka" class="form-label">Marka</label>
      <input type="text" class="form-control" id="marka" />
    </div>
    <div class="col-md-6">
      <label for="model" class="form-label">Model</label>
      <input type="text" class="form-control" id="model" />
    </div>

    <div class="col-md-6">
      <label for="yil" class="form-label">Model Yılı</label>
      <input type="number" class="form-control" id="yil" min="1900" />
    </div>
    <div class="col-md-6">
      <label for="km" class="form-label">Kilometre</label>
      <input type="number" class="form-control" id="km" min="0" />
    </div>
    
    <div class="col-md-6">
  <label for="renk" class="form-label">Renk</label>
  <input type="text" class="form-control" id="renk" />
</div>
    <div class="col-md-6">
    <label for="sasi" class="form-label">Şasi Numarası</label>
   <input type="text" class="form-control" id="sasi" />
    </div>

    <div class="col-md-6">
  <label for="vites" class="form-label">Vites</label>
  <select class="form-select" id="vites">
    <option value="">Seçiniz...</option>
    <option value="Manuel">Manuel</option>
    <option value="Otomatik">Otomatik</option>
    <option value="Yarı Otomatik">Yarı Otomatik</option>
    </select>
</div>
    <div class="col-md-6">
  <label for="yakit" class="form-label">Yakıt</label>
  <select class="form-select" id="yakit">
    <option value="">Seçiniz...</option>
    <option value="Benzin">Benzin</option>
    <option value="Dizel">Dizel</option>
    <option value="LPG">LPG</option>
    <option value="Elektrikli">Elektrikli</option>
    <option value="Hibrit (Benzinli)">Hibrit (Benzinli)</option>
    <option value="Hibrit (Dizel)">Hibrit (Dizel)</option>
  </select>
</div>
  </div>
</div>


          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
            <button type="submit" class="btn btn-primary">Ekle</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Silme Onay Modalı -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Silme Onayı</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        Bu aracı silmek istediğinize emin misiniz?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Sil</button>
      </div>
    </div>
  </div>
</div>


  <!-- Araç Güncelleme Modalı -->
<div class="modal fade" id="updateVehicleModal" tabindex="-1" aria-labelledby="updateVehicleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="updateVehicleForm">
        <div class="modal-header">
          <h5 class="modal-title" id="updateVehicleModalLabel">Araç Güncelle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="updatePlaka" class="form-label">Plaka *</label>
              <input type="text" class="form-control" id="updatePlaka" readonly />
            </div>
            <div class="col-md-6">
              <label for="updateDurum" class="form-label">Durum</label>
              <select class="form-select" id="updateDurum">
                <option value="">Seçiniz...</option>
                <option value="Kiralanabilir">Kiralanabilir</option>
                <option value="Kirada">Kirada</option>
                <option value="Serviste">Serviste</option>
                <option value="Bakımda">Bakımda</option>
                <option value="Yıkamada">Yıkamada</option>
                <option value="Yakıt İkmalinde">Yakıt İkmalinde</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="updateMarka" class="form-label">Marka</label>
              <input type="text" class="form-control" id="updateMarka" />
            </div>
            <div class="col-md-6">
              <label for="updateModel" class="form-label">Model</label>
              <input type="text" class="form-control" id="updateModel" />
            </div>
            <div class="col-md-6">
              <label for="updateYil" class="form-label">Model Yılı</label>
              <input type="number" class="form-control" id="updateYil" min="1900" />
            </div>
            <div class="col-md-6">
              <label for="updateKm" class="form-label">Kilometre</label>
              <input type="number" class="form-control" id="updateKm" min="0" />
            </div>
            <div class="col-md-6">
         <label for="updateRenk" class="form-label">Renk</label>
        <input type="text" class="form-control" id="updateRenk" />
</div>
          <div class="col-md-6">
          <label for="updateSasi" class="form-label">Şasi Numarası</label>
          <input type="text" class="form-control" id="updateSasi" />
            </div>
            <div class="col-md-6">
              <label for="updateVites" class="form-label">Vites</label>
              <select class="form-select" id="updateVites">
                <option value="">Seçiniz...</option>
                <option value="Manuel">Manuel</option>
                <option value="Otomatik">Otomatik</option>
                <option value="Yarı Otomatik">Yarı Otomatik</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="updateYakit" class="form-label">Yakıt</label>
              <select class="form-select" id="updateYakit">
                <option value="">Seçiniz...</option>
                <option value="Benzin">Benzin</option>
                <option value="Dizel">Dizel</option>
                <option value="LPG">LPG</option>
                <option value="Elektrikli">Elektrikli</option>
                <option value="Hibrit (Benzinli)">Hibrit (Benzinli)</option>
                <option value="Hibrit (Dizel)">Hibrit (Dizel)</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
          <button type="submit" class="btn btn-primary">Güncelle</button>
        </div>
      </form>
    </div>
  </div>
</div>


  <div
    class="position-fixed top-0 start-50 translate-middle-x p-3"
    style="z-index: 9999"
  >
    <div
      id="loginToast"
      class="toast align-items-center text-white bg-success border-0"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"

    >
      <div class="d-flex">
        <div class="toast-body">✅ Başarılı bir şekilde giriş yaptınız.</div>
        <button
          type="button"
          class="btn-close btn-close-white me-2 m-auto"
          data-bs-dismiss="toast"
          aria-label="Kapat"
        ></button>
      </div>
      </div>

      <div
    id="vehicleAddedToast"
    class="toast align-items-center text-white bg-success border-0 mt-2"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
  >
    <div class="d-flex">
      <div class="toast-body"> Araç başarıyla eklendi!</div>
      <button
        type="button"
        class="btn-close btn-close-white me-2 m-auto"
        data-bs-dismiss="toast"
        aria-label="Kapat"
      ></button>
    </div>
  </div>
  
    <div
  id="vehicleErrorToast"
  class="toast align-items-center text-white bg-danger border-0 mt-2"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
>
  <div class="d-flex">
    <div class="toast-body" id="vehicleErrorMessage">Araç eklenirken bir hata oluştu.</div>
    <button
      type="button"
      class="btn-close btn-close-white me-2 m-auto"
      data-bs-dismiss="toast"
      aria-label="Kapat"
    ></button>
  </div>
</div>

  <!-- Araç Silindi Toast -->
<div id="vehicleDeletedToast" class="toast align-items-center text-white bg-success border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body">✅ Araç başarıyla silindi.</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
  </div>
</div>

<!-- Araç Silinemedi Toast -->
<div id="vehicleDeleteErrorToast" class="toast align-items-center text-white bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body" id="vehicleDeleteErrorMessage">❌ Araç silinirken hata oluştu.</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
  </div>
</div>

   <div id="vehicleUpdateSuccessToast" class="toast align-items-center text-white bg-success border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body" id="vehicleUpdateSuccessMessage">✅ Araç başarıyla güncellendi.</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
  </div>
</div> 
<div id="vehicleUpdateErrorToast" class="toast align-items-center text-white bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body" id="vehicleUpdateErrorMessage">❌ Araç güncellenirken hata oluştu.</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
  </div>
</div>
     
  </div>
  

  <script>
    const sidebar = document.getElementById("sidebar");
    const content = document.getElementById("main-content");
    let previousWidth = window.innerWidth;

    function isMobileView() {
      return window.innerWidth < 992;
    }

    function setSidebarState(hidden) {
      sidebar.classList.toggle("hidden", hidden);
      content.classList.toggle("full", hidden);
      sessionStorage.setItem("sidebarHidden", hidden);
    }

    function toggleSidebar() {
      const isHidden = sidebar.classList.toggle("hidden");
      content.classList.toggle("full", isHidden);
      sessionStorage.setItem("sidebarHidden", isHidden);
    }

    function initializeSidebar() {
      const stored = sessionStorage.getItem("sidebarHidden");
      const isMobile = isMobileView();
      if (stored === null) {
        setSidebarState(isMobile);
      } else {
        if (!isMobile) {
          setSidebarState(false);
          sessionStorage.removeItem("sidebarHidden");
        } else {
          setSidebarState(stored === "true");
        }
      }
    }

    function handleResize() {
      const currentWidth = window.innerWidth;
      const wasMobile = previousWidth < 992;
      const isNowMobile = currentWidth < 992;
      if (!wasMobile && isNowMobile) {
        const isHidden = sidebar.classList.contains("hidden");
        if (!isHidden) {
          setSidebarState(true);
        }
      }
      previousWidth = currentWidth;
    }
    function openUpdateModal(vehicle) {
  document.getElementById("updatePlaka").value = vehicle.plaka || "";
  document.getElementById("updateDurum").value = vehicle.durum || "";
  document.getElementById("updateMarka").value = vehicle.marka || "";
  document.getElementById("updateModel").value = vehicle.model || "";
  document.getElementById("updateYil").value = vehicle.yil || "";
  document.getElementById("updateKm").value = vehicle.km || "";
  document.getElementById("updateRenk").value = vehicle.renk || "";
  document.getElementById("updateSasi").value = vehicle.sasi || "";
  document.getElementById("updateVites").value = vehicle.vites || "";
  document.getElementById("updateYakit").value = vehicle.yakit || "";

  const updateModalEl = document.getElementById("updateVehicleModal");
  const modal = new bootstrap.Modal(updateModalEl);
  modal.show();
}


    window.addEventListener("load", initializeSidebar);
    window.addEventListener("resize", handleResize);

    window.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      const userName = localStorage.getItem("userName");
      const loginBtn = document.getElementById("login-btn");
      const userNameSpan = document.getElementById("user-name");
      const logoutBtn = document.getElementById("logout-btn");
      const currentYear = new Date().getFullYear();
      const plakaInput = document.getElementById("plaka");
  plakaInput.addEventListener("input", function () {
    this.value = this.value.toUpperCase();
  });
        const yeniAracBtn = document.querySelector('button[data-bs-target="#newVehicleModal"]');
  if (yeniAracBtn) yeniAracBtn.style.display = token ? "inline-block" : "none";

  // Güncelle ve sil butonlarının görünürlüğünü ayarla
  setActionButtonsVisibility();
      document.getElementById("updateYil").setAttribute("max", currentYear);

      document.getElementById("yil").setAttribute("max", currentYear);
      
      if (token && userName) {
        loginBtn.style.display = "none";
        userNameSpan.style.display = "inline";
        userNameSpan.textContent = userName;
        logoutBtn.style.display = "inline-block";
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("token");
          localStorage.removeItem("userName");
          window.location.href = "home.html";
        });
      } else {
        loginBtn.style.display = "inline-block";
        userNameSpan.style.display = "none";
        logoutBtn.style.display = "none";
      }

      const showToast = sessionStorage.getItem("showLoginToast");
      if (showToast === "true") {
        const toast = new bootstrap.Toast(
          document.getElementById("loginToast"),
          { delay: 3000 }
        );
        toast.show();
        sessionStorage.removeItem("showLoginToast");
      }

      fetchVehicles();
    });

    let allVehicles = [];

    async function fetchVehicles() {
      try {
        const token = localStorage.getItem("token");
        const response = await fetch("http://localhost:3000/allvehicles", {
          headers: token ? { Authorization: "Bearer " + token } : {},
        });
        if (!response.ok) throw new Error("Sunucu hatası");

        allVehicles = await response.json();
        renderVehicles(allVehicles);
      } catch (err) {
        console.error("Araçlar alınamadı:", err);
        const tbody = document.querySelector("#vehicles-table tbody");
        tbody.innerHTML =
          '<tr><td colspan="9" class="text-danger">Araçlar yüklenirken hata oluştu.</td></tr>';
      }
    }

    let plakaToDelete = null;

function renderVehicles(vehicles) {
  const tbody = document.querySelector("#vehicles-table tbody");
  tbody.innerHTML = "";

  vehicles.forEach((vehicle) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${vehicle.plaka || ""}</td>
      <td>${vehicle.durum || ""}</td>
      <td>${vehicle.marka || ""}</td>
      <td>${vehicle.model || ""}</td>
      <td>${vehicle.yil || ""}</td>
      <td>${vehicle.km || ""}</td>
      <td>${vehicle.vites || ""}</td>
      <td>${vehicle.yakit || ""}</td>
      <td>
        <button class="btn btn-sm me-2 detail-btn" title="Detay">&gt;</button>
        <button class="btn btn-sm btn-primary me-2 update-btn">Güncelle</button>
        <button class="btn btn-sm btn-danger delete-btn">Sil</button>

      </td>
    `;
    tbody.appendChild(tr);
    
    tr.querySelector(".update-btn").addEventListener("click", () => {
      openUpdateModal(vehicle);
    });

    tr.querySelector(".delete-btn").addEventListener("click", () => {
      plakaToDelete = vehicle.plaka;
      const deleteModalEl = document.getElementById("deleteConfirmModal");
      const deleteModal = new bootstrap.Modal(deleteModalEl);
      deleteModal.show();
    });

     tr.querySelector(".detail-btn").addEventListener("click", () => {
      // Var olan detay satırını bul
      const existingDetailRow = tbody.querySelector(".detail-row");

      // Eğer detay zaten açılmış ve aynı satırın altındaysa kapat
      if (existingDetailRow && existingDetailRow.previousSibling === tr) {
        existingDetailRow.remove();
        return; // Kapattık, fonksiyonu bitir
      }

      // Diğer açılmış detay satırı varsa kapat
      if (existingDetailRow) {
        existingDetailRow.remove();
      }

      // Yeni detay satırı oluştur
      const detailTr = document.createElement("tr");
detailTr.classList.add("detail-row");
detailTr.innerHTML = `
  <td colspan="9" style="background-color: #f8f9fa; padding: 0;">
    <div style="margin: 0 4px; padding: 15px; background-color:  #f8f9fa; ">
       <strong>Renk:</strong> ${vehicle.renk || 'Bilgi yok'}<br />
        <strong>Şasi Numarası:</strong> ${vehicle.sasi || 'Bilgi yok'}<br/>
       <strong>Oluşturan:</strong> ${vehicle.olusturan || 'Bilgi yok'}

    </div>
  </td>
`;

      // Detay satırını tıklanan satırın hemen altına ekle
      tr.parentNode.insertBefore(detailTr, tr.nextSibling);
    });

    
  });
  setActionButtonsVisibility();
}

  // Silme onay butonuna tıklanınca:
document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
  if (!plakaToDelete) return;

  try {
    const token = localStorage.getItem("token");
    const response = await fetch(`http://localhost:3000/allvehicles/${encodeURIComponent(plakaToDelete)}`, {
      method: "DELETE",
      headers: token ? { Authorization: "Bearer " + token } : {},
    });

    if (!response.ok) {
      const errMsg = await response.text();
      throw new Error("Silme işlemi başarısız: " + errMsg);
    }

    // Modalı kapat
    const deleteModalEl = document.getElementById("deleteConfirmModal");
    const deleteModalInstance = bootstrap.Modal.getInstance(deleteModalEl);
    deleteModalInstance.hide();

    plakaToDelete = null;

    // Listeyi güncelle
    await fetchVehicles();

    // ✅ TOAST MESAJI GÖSTER
    const deleteToast = new bootstrap.Toast(document.getElementById("vehicleDeletedToast"), {
      delay: 3000,
    });
    deleteToast.show();

  } catch (error) {
    // ❌ HATA TOAST
    const errorMsg = document.getElementById("vehicleDeleteErrorMessage");
    errorMsg.textContent = "❌ " + error.message;

    const errorToast = new bootstrap.Toast(document.getElementById("vehicleDeleteErrorToast"), {
      delay: 3000,
    });
    errorToast.show();
  }
});

   document.getElementById("searchForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const searchText = document.getElementById("plateSearch").value.trim().toLowerCase();

  if (searchText === "") {
    
    renderVehicles(allVehicles);
  } else {
    
    const filtered = allVehicles.filter(v =>
      v.plaka?.toLowerCase().startsWith(searchText)
    );
    
    renderVehicles(filtered.length ? filtered : allVehicles);
  }
});


    



    // Yeni Araç Form Gönderimi
    document.getElementById("newVehicleForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const newVehicle = {
    plaka: document.getElementById("plaka").value.trim(),
    durum: document.getElementById("durum").value.trim(),
    marka: document.getElementById("marka").value.trim(),
    model: document.getElementById("model").value.trim(),
    yil: document.getElementById("yil").value
      ? Number(document.getElementById("yil").value)
      : undefined,
    km: document.getElementById("km").value
      ? Number(document.getElementById("km").value)
      : undefined,
    vites: document.getElementById("vites").value.trim(),
    yakit: document.getElementById("yakit").value.trim(),
    renk: document.getElementById("renk").value.trim(),     
    sasi: document.getElementById("sasi").value.trim()      
  };

  try {
    const token = localStorage.getItem("token");
    const response = await fetch("http://localhost:3000/allvehicles", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...(token ? { Authorization: "Bearer " + token } : {}),
      },
      body: JSON.stringify(newVehicle),
    });

    if (!response.ok) {
      const errText = await response.text();
      throw new Error("Araç eklenirken hata oluştu: " + errText);
    }

    const modalElement = document.getElementById("newVehicleModal");
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    modalInstance.hide();

    this.reset();

    await fetchVehicles();

    // Başarıyla eklenince toast bildirimi göster
    const addedToast = new bootstrap.Toast(document.getElementById("vehicleAddedToast"), {
      delay: 3000,
    });
    addedToast.show();

  } catch (error) {
    const errorMsg = document.getElementById("vehicleErrorMessage");


const errorToast = new bootstrap.Toast(document.getElementById("vehicleErrorToast"), {
  delay: 3000,
});
errorToast.show();
  }
});

   document.getElementById("updateVehicleForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // Sayfa yenilenmesin

    const updatedVehicle = {
      plaka: document.getElementById("updatePlaka").value.trim(),
      durum: document.getElementById("updateDurum").value.trim(),
      marka: document.getElementById("updateMarka").value.trim(),
      model: document.getElementById("updateModel").value.trim(),
      yil: document.getElementById("updateYil").value
        ? Number(document.getElementById("updateYil").value)
        : undefined,
      km: document.getElementById("updateKm").value
        ? Number(document.getElementById("updateKm").value)
        : undefined,
      vites: document.getElementById("updateVites").value.trim(),
      yakit: document.getElementById("updateYakit").value.trim(),
        renk: document.getElementById("updateRenk").value.trim(),     
      sasi: document.getElementById("updateSasi").value.trim()      
    };

    try {
      const token = localStorage.getItem("token");
      const response = await fetch(`http://localhost:3000/allvehicles/${encodeURIComponent(updatedVehicle.plaka)}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          ...(token ? { Authorization: "Bearer " + token } : {}),
        },
        body: JSON.stringify(updatedVehicle),
      });

      if (!response.ok) {
        const errText = await response.text();
        throw new Error("Güncelleme sırasında hata oluştu: " + errText);
      }

      // Modalı kapat
      const modalElement = document.getElementById("updateVehicleModal");
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      modalInstance.hide();

      // Listeyi yeniden yükle
      await fetchVehicles();

      // Başarı mesajı
      showVehicleUpdateToast(true, "✅ Araç başarıyla güncellendi!");
    } catch (error) {
      showVehicleUpdateToast(false, error.message || "❌ Araç güncellenirken bir hata oluştu.");
    }

    
  });
  const sortStates = {
  plaka: 0,
  durum: 0,
  marka: 0,
  model: 0,
  modelyilii: 0,
  kilometre: 0,
  vites: 0,
  yakit: 0
};

function updateSortIcon(columnKey, state) {
  const icon = document.getElementById(`${columnKey}-sort-icon`);
  if (!icon) return;

  let rects = ["gray", "gray", "gray"];
  if (state === 1) rects[1] = "black";
  else if (state === 2) rects[2] = "black";
  else rects[0] = "black"; // default: ilk çizgi kalın

  icon.innerHTML = `
    <svg width="14" height="14" viewBox="0 0 14 14">
      <rect width="14" height="2" y="0" fill="${rects[0]}" />
      <rect width="14" height="2" y="6" fill="${rects[1]}" />
      <rect width="14" height="2" y="12" fill="${rects[2]}" />
    </svg>
  `;
}

function resetAllSortStates(activeKey) {
  Object.keys(sortStates).forEach(key => {
    if (key !== activeKey) {
      sortStates[key] = 0;
    }
  });
  
  // Sıralama ikonlarını güncelle
  Object.keys(sortStates).forEach(key => {
    updateSortIcon(key, sortStates[key]);
  });
}
function sortVehiclesByKey(key, sortState) {
  if (sortState === 0) return [...allVehicles]; // Sıralama yok, orijinal liste

  const sorted = [...allVehicles].sort((a, b) => {
    let valA = a[key];
    let valB = b[key];

    // Plaka için özel sıralama: önce rakamlar, sonra harfler, sonra rakamlar
    if (key === "plaka") {
      // Burada plaka formatına göre sıralama yapılmalı, basit örnek:
      const regex = /^(\d+)([A-Za-z]+)(\d+)$/;
      const matchA = valA.match(regex);
      const matchB = valB.match(regex);

      if (matchA && matchB) {
        // Önce ilk sayı karşılaştırması
        const numA1 = parseInt(matchA[1]);
        const numB1 = parseInt(matchB[1]);
        if (numA1 !== numB1) return (numA1 - numB1) * (sortState === 1 ? 1 : -1);

        // Sonra harf kısmı
        if (matchA[2] !== matchB[2])
          return (matchA[2] < matchB[2] ? -1 : 1) * (sortState === 1 ? 1 : -1);

        // Son sayı
        const numA2 = parseInt(matchA[3]);
        const numB2 = parseInt(matchB[3]);
        return (numA2 - numB2) * (sortState === 1 ? 1 : -1);
      }
      // Eğer format farklıysa string karşılaştırması
      return (valA < valB ? -1 : 1) * (sortState === 1 ? 1 : -1);
    }

    // String karşılaştırma için:
    if (typeof valA === "string") valA = valA.toLowerCase();
    if (typeof valB === "string") valB = valB.toLowerCase();

    if (valA < valB) return sortState === 1 ? -1 : 1;
    if (valA > valB) return sortState === 1 ? 1 : -1;
    return 0;
  });

  return sorted;
}
document.getElementById("plaka-header").addEventListener("click", () => {
  sortStates.plaka = (sortStates.plaka + 1) % 3;
  resetAllSortStates("plaka");

  const sorted = sortVehiclesByKey("plaka", sortStates.plaka);
  renderVehicles(sorted);
});

document.getElementById("durum-header").addEventListener("click", () => {
  sortStates.durum = (sortStates.durum + 1) % 3;
  resetAllSortStates("durum");

  const sorted = sortVehiclesByKey("durum", sortStates.durum);
  renderVehicles(sorted);
});

document.getElementById("marka-header").addEventListener("click", () => {
  sortStates.marka = (sortStates.marka + 1) % 3;
  resetAllSortStates("marka");

  const sorted = sortVehiclesByKey("marka", sortStates.marka);
  renderVehicles(sorted);
});

document.getElementById("model-header").addEventListener("click", () => {
  sortStates.model = (sortStates.model + 1) % 3;
  resetAllSortStates("model");

  const sorted = sortVehiclesByKey("model", sortStates.model);
  renderVehicles(sorted);
});

document.getElementById("modelyilii-header").addEventListener("click", () => {
  sortStates.modelyilii = (sortStates.modelyilii + 1) % 3;
  resetAllSortStates("modelyilii");
  updateSortIcon("modelyilii", sortStates.modelyilii);

  const sorted = sortVehiclesByKey("yil", sortStates.modelyilii);
  renderVehicles(sorted);
});

document.getElementById("kilometre-header").addEventListener("click", () => {
  sortStates.kilometre = (sortStates.kilometre + 1) % 3;
  resetAllSortStates("kilometre");

  const sorted = sortVehiclesByKey("km", sortStates.kilometre);
  renderVehicles(sorted);
});

document.getElementById("vites-header").addEventListener("click", () => {
  sortStates.vites = (sortStates.vites + 1) % 3;
  resetAllSortStates("vites");

  const sorted = sortVehiclesByKey("vites", sortStates.vites);
  renderVehicles(sorted);
});

document.getElementById("yakit-header").addEventListener("click", () => {
  sortStates.yakit = (sortStates.yakit + 1) % 3;
  resetAllSortStates("yakit");

  const sorted = sortVehiclesByKey("yakit", sortStates.yakit);
  renderVehicles(sorted);
});
function setActionButtonsVisibility() {
  const token = localStorage.getItem("token");
  const updateBtns = document.querySelectorAll(".update-btn");
  const deleteBtns = document.querySelectorAll(".delete-btn");

  updateBtns.forEach(btn => {
    btn.style.display = token ? "inline-block" : "none";
  });

  deleteBtns.forEach(btn => {
    btn.style.display = token ? "inline-block" : "none";
  });
}

function showVehicleUpdateToast(success, message) {
  if (success) {
    document.getElementById("vehicleUpdateSuccessMessage").textContent = message;
    const toast = new bootstrap.Toast(document.getElementById("vehicleUpdateSuccessToast"));
    toast.show();
  } else {
    document.getElementById("vehicleUpdateErrorMessage").textContent = message;
    const toast = new bootstrap.Toast(document.getElementById("vehicleUpdateErrorToast"));
    toast.show();
  }
}
  </script>
</body>

</html>
